<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Kecho">
    
    <title>
        
            RuoYiPlus 扩展 JustAuth 支持 Welink 登录 |
        
        Kecho&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/favicon.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
        
            
                
<link rel="stylesheet" href="/css/custom/mathjax.css">

            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"kechocy.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"Kecho's Blog","author":"Kecho","avatar":"/images/avatar.jpg","logo":"/images/logo_light.svg","logo_dark":"/images/logo_dark.svg","favicon":"/images/favicon.svg"},"menu":{"home":"/","categories":"/categories","archives":"/archives","tags":"/tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":true,"percent":false,"hide_header":false},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":false,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":true},"datetime_format":"YYYY-MM-DD","copyright_info":false,"share":true,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"toc":{"enable":true,"number":true,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"gitalk","valine":{"appid":"Z42hS0SIqBC8NQsPJkjMfafZ-MdYXbMMI","appkey":"QvwHhW2n8wzjOx5qgMhx3193","server_urls":null,"placeholder":"说点什么吧！"},"gitalk":{"github_id":"kechocy","github_admins":null,"repository":"HexoBlogComment","client_id":"Ov23lijlSHIogUNeavXU","client_secret":"14f1771243fbbcaa595c6f2bf116556a00f9de81","proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2022,"word_count":true,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":true,"css":["/css/custom/mathjax.css"],"js":[null]},"root":"","source_data":{"links":[{"name":"XPoet","link":"https://xpoet.cn/","description":"hexo-keep主题作者","avatar":"https://cdn.staticaly.com/gh/XPoet/image-hosting@master/common-use/avatar.jpg"},{"name":"友人C","link":"https://www.ihewro.com/","description":"typecho-handsome主题作者","avatar":"https://www.ihewro.com/favicon.ico"},{"name":"Kinlon博客小站","link":"https://blog.kinlon.work/","description":"记录学习生活的小站","avatar":"https://q.qlogo.cn/headimg_dl?dst_uin=1154577806&spec=640&img_type=jpg"},{"name":"kk","link":"https://f-bee.github.io/","description":"学习、工作の小记","avatar":"https://f-bee.github.io/img/avatar02.png"}]},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Kecho's Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo_light.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Kecho&#39;s Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        RuoYiPlus 扩展 JustAuth 支持 Welink 登录
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.jpg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">Kecho</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-09-06</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Sat Sep 06 2025 10:54:22 GMT+0800">2025-09-06</span>
                </span>
            
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/JustAuth/">JustAuth</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Welink/">Welink</a></li>
                        
                    
                </ul>
            </span>
        

        
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>23 分钟</span>
            </span>
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p>RuoYiPlus 使用 JustAuth 进行三方登录，但是 JustAuth 不支持 Welink 登录，本文将介绍如何扩展 JustAuth 以支持 Welink 登录，并适配 RuoYiPlus 项目。</p>
<span id="more"></span>


<p><a class="link"   target="_blank" rel="noopener" href="https://www.justauth.cn/" >JustAuth 文档<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://plus-doc.dromara.org/#/ruoyi-vue-plus/home" >RuoYiPlus 后端文档<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://plus-doc.dromara.org/#/plus-ui/home" >RuoYiPlus 前端文档<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="第三方网站-Welink-登录流程"><a href="#第三方网站-Welink-登录流程" class="headerlink" title="第三方网站 Welink 登录流程"></a>第三方网站 Welink 登录流程</h2><p>免登录时，可以由前端生成 code 传递给后端，由后端去请求 Welink 接口返回用户信息给前端。也可以通过 OAuth 方式，由后端构造三方授权地址传递给前端跳转到指定地址，授权通过后再由 Welink 携带 code 返回到重定向地址，前端再将 code 传递给后端，由后端去请求 Welink 接口返回用户信息给前端。</p>
<h3 id="前台免登录"><a href="#前台免登录" class="headerlink" title="前台免登录"></a>前台免登录</h3><p>我们先来了解一下 <a class="link"   target="_blank" rel="noopener" href="https://open.welink.huaweicloud.com/docs/#/990hh0/whokyc/zv6f8s" >Welink 的免登录流程<i class="fas fa-external-link-alt"></i></a>：</p>
<ol>
<li>前端生成 code 传递给后端</li>
<li>后端使用 client_id 和 client_secret 请求三方得到 access_token</li>
<li>后端使用 code 和 access_token 请求三方得到 userId</li>
<li>后端使用 userId 和 access_token 请求三方得到用户详细信息</li>
</ol>
<p>PC 端生成 code 授权码有两种形式（移动端可参考 <a class="link"   target="_blank" rel="noopener" href="https://open.welink.huaweicloud.com/docs/#/990hh0/whokyc/48s22j" >移动端获取授权登录码 | WeLink<i class="fas fa-external-link-alt"></i></a>）：</p>
<ol>
<li>通过 Welink 打开轻应用</li>
<li>通过扫码登录</li>
</ol>
<p>先说<a class="link"   target="_blank" rel="noopener" href="https://open.welink.huaweicloud.com/docs/#/990hh0/whokyc/xdmzas" >通过 Welink 打开轻应用<i class="fas fa-external-link-alt"></i></a>：</p>
<ol>
<li><p>需要在 Welink 后台配置轻应用的 PC 端首页地址：</p>
<p> 假定 PC 端打开链接为：<code>https://www.example.com/index</code>，需要在链接后面添加参数：<code>code=$(code)</code>，那么配置地址则为：<code>https://www.example.com/index?code=$(code)</code></p>
</li>
<li><p>从 URLSearchParams 获取 code 提交给后端向三方请求用户信息：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">getWelinkLoginCode</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> urlParams = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> code = urlParams.<span class="title function_">get</span>(<span class="string">&quot;code&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (code) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 发送请求将 code 传递给后端</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">loginWithCode</span>(code);</span></span><br><span class="line"><span class="language-javascript">	</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>再说<a class="link"   target="_blank" rel="noopener" href="https://open.welink.huaweicloud.com/docs/#/990hh0/whokyc/i0wzzh" >扫码登录<i class="fas fa-external-link-alt"></i></a>：</p>
<ol>
<li><p>前端引入 js 文件：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://login.welink.huaweicloud.com/sso-proxy-front/public/qrcode/0.0.1/wlQrcodeLogin.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>前端构造二维码：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;welink-login-container&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 生成二维码</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">getWelinkLoginERCode</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> clientId = <span class="string">&quot;2025xxxxxxxxxxx1413&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> state = <span class="title class_">Date</span>.<span class="title function_">now</span>().<span class="title function_">toString</span>();</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> redirectUri  = <span class="string">&#x27;https://www.example.com/social-callback?source=welink&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="title function_">wlQrcodeLogin</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">id</span>: <span class="string">&quot;welink-login-container&quot;</span>, <span class="comment">// 这里需要你在自己的页面定义一个 HTML 标签并设置 id，例如 &lt;div id=&quot;welink-login-container&quot;&gt;&lt;/div&gt;，也可以使用 span</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">client_id</span>: clientId, </span></span><br><span class="line"><span class="language-javascript">    <span class="attr">response_type</span>: <span class="string">&quot;code&quot;</span>, </span></span><br><span class="line"><span class="language-javascript">    <span class="attr">scope</span>: <span class="string">&quot;snsapi_login&quot;</span>, </span></span><br><span class="line"><span class="language-javascript">    <span class="attr">state</span>: state, </span></span><br><span class="line"><span class="language-javascript">    <span class="attr">redirect_uri</span>: redirectUri,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">style</span>: <span class="string">&quot;border:none;background-color:#FFFFFF;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    width : <span class="string">&quot;400&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">height</span>: <span class="string">&quot;300&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">lang</span>: <span class="string">&#x27;cn&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">self_redirect</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> <strong>注意</strong>：redirectUri 的域名或 IP 需要和 Welink 后台设置的 “应用管理后台” 地址保持一致，并且不能使用 localhost，否则可能导致二维码生成失败。</p>
</li>
<li><p>从 MessageEvent 获取 code 提交给后端向三方请求用户信息：</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">const</span> <span class="title function_">getWelinkLoginCode</span> = (<span class="params">event</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> origin = event.<span class="property">origin</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span>(origin === <span class="string">&quot;https://login.welink.huaweicloud.com&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> code = event.<span class="property">data</span> <span class="keyword">as</span> string;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(code);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(code) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 发送请求将 code 传递给后端</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">loginWithCode</span>(code);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">addEventListener</span> != <span class="string">&#x27;undefined&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, getWelinkLoginCode, <span class="literal">false</span>);</span></span><br><span class="line"><span class="language-javascript"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">attachEvent</span> != <span class="string">&#x27;undefined&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="variable language_">window</span>.<span class="title function_">attachEvent</span>(<span class="string">&#x27;onmessage&#x27;</span>, getWelinkLoginCode);</span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="管理后台免登录"><a href="#管理后台免登录" class="headerlink" title="管理后台免登录"></a>管理后台免登录</h3><p>上面说的都是由前台产生 code 传递给后台，然后后台拿 code 去请求三方获取信息。</p>
<p>下面将介绍 <a class="link"   target="_blank" rel="noopener" href="https://open.welink.huaweicloud.com/docs/#/990hh0/whokyc/3hs4bu" >Welink 中 OAuth 登录方式<i class="fas fa-external-link-alt"></i></a>流程：</p>
<ol>
<li>前端点击按钮后向后端发送请求</li>
<li>后端构造三方跳转地址并返回前端</li>
<li>前端跳转指定三方跳转地址</li>
<li>三方会判断用户是否登录三方，没有则跳转三方登录页，登录后三方会生成 code 并带参跳转到 redirect_uri 地址</li>
<li>可以在前端判断用户是否是登录状态，请求后端对应的接口处理</li>
</ol>
<h2 id="JustAuth-扩展流程"><a href="#JustAuth-扩展流程" class="headerlink" title="JustAuth 扩展流程"></a>JustAuth 扩展流程</h2><p>根据  <a class="link"   target="_blank" rel="noopener" href="https://www.justauth.cn/features/customize-the-oauth/" >自定义第三方平台的OAuth | JustAuth<i class="fas fa-external-link-alt"></i></a> 可以得知扩展步骤主要分为三步：</p>
<ol>
<li>在 application.yml 配置 justauth 中第三方平台的 client_id 和 client_secret 等信息</li>
<li>创建一个类实现 AuthSource 接口</li>
<li>创建一个类继承 AuthDefaultRequest 类，并重写 getAccessToken 和 getUserInfo 方法</li>
</ol>
<p>JustAuth 官方文档中例子的源码可见：<a class="link"   target="_blank" rel="noopener" href="https://github.com/justauth/JustAuth-demo/blob/master/src/main/java/me/zhyd/justauth/custom/AuthMyGitlabRequest.java" >AuthMyGitlabRequest.java | Github<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="理解-RuoYiPlus-中三方登录流程"><a href="#理解-RuoYiPlus-中三方登录流程" class="headerlink" title="理解 RuoYiPlus 中三方登录流程"></a>理解 RuoYiPlus 中三方登录流程</h2><blockquote>
<p>结论：RuoYiPlus 中需要先绑定三方账号，才能使用三方登录。</p>
</blockquote>
<p>前端在 login.vue 登录页面或登录后 thirdParty.vue 绑定应用页面都会调用 <code>/binding/&#123;source&#125;</code> 接口。</p>
<p>后端将创建 AuthRequest 调用 authorize 方法构造三方跳转地址 （会用到 yml 中配置的信息）并传递给前端（AuthController 中 authBinding 方法）。</p>
<p>前端跳转到指定三方地址后由三方返回到指定的重定向地址 <code>/social-callback</code>（此路由对应前端 SocialCallback.vue 页面）。</p>
<p>前端 SocialCallback.vue 中会判断是否是登录状态，如果已登录则请求 <code>/social/callback</code> 接口，未登录则请求 <code>login</code> 接口（AuthController 中 socialCallback 和 login 方法 ）。</p>
<p>AuthController 中 login 方法中最关键的是 <code>LoginVo loginVo = IAuthStrategy.login(body, client, grantType)</code>，点进去看一下 IAuthStrategy.login 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> LoginVo <span class="title function_">login</span><span class="params">(String body, SysClientVo client, String grantType)</span> &#123;</span><br><span class="line">    <span class="comment">// 授权类型和客户端id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> grantType + BASE_NAME;</span><br><span class="line">    <span class="keyword">if</span> (!SpringUtils.containsBean(beanName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="string">&quot;授权类型不正确!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">IAuthStrategy</span> <span class="variable">instance</span> <span class="operator">=</span> SpringUtils.getBean(beanName);</span><br><span class="line">    <span class="keyword">return</span> instance.login(body, client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 grantType 是 “social”，BASE_NAME 就是 “AuthStrategy”，所以实际调用的是 socialAuthStrategy.login 方法。再看一下 SocialAuthStrategy 中 login 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> LoginVo <span class="title function_">login</span><span class="params">(String body, SysClientVo client)</span> &#123;</span><br><span class="line">    <span class="type">SocialLoginBody</span> <span class="variable">loginBody</span> <span class="operator">=</span> JsonUtils.parseObject(body, SocialLoginBody.class);</span><br><span class="line">    ValidatorUtils.validate(loginBody);</span><br><span class="line">    AuthResponse&lt;AuthUser&gt; response = SocialUtils.loginAuth(</span><br><span class="line">        loginBody.getSource(), loginBody.getSocialCode(),</span><br><span class="line">        loginBody.getSocialState(), socialProperties);</span><br><span class="line">    <span class="keyword">if</span> (!response.ok()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(response.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthUser</span> <span class="variable">authUserData</span> <span class="operator">=</span> response.getData();</span><br><span class="line">    <span class="comment">/// 以下省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到就是通过 SocialUtils.loginAuth 方法来调用三方接口，拿到用户信息。再看一下 SocialUtils.loginAuth 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AuthResponse&lt;AuthUser&gt; <span class="title function_">loginAuth</span><span class="params">(String source, String code, String state, SocialProperties socialProperties)</span> <span class="keyword">throws</span> AuthException &#123;</span><br><span class="line">    <span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> getAuthRequest(source, socialProperties);</span><br><span class="line">    <span class="type">AuthCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthCallback</span>();</span><br><span class="line">    callback.setCode(code);</span><br><span class="line">    callback.setState(state);</span><br><span class="line">    <span class="keyword">return</span> authRequest.login(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到是先调用 getAuthRequest 获取到对应平台的 AuthRequest 类，然后调用其中的 login 方法。我们再看一下 getAuthRequest 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AuthRequest <span class="title function_">getAuthRequest</span><span class="params">(String source, SocialProperties socialProperties)</span> <span class="keyword">throws</span> AuthException &#123;</span><br><span class="line">    <span class="type">SocialLoginConfigProperties</span> <span class="variable">obj</span> <span class="operator">=</span> socialProperties.getType().get(source);</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.isNull(obj)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(<span class="string">&quot;不支持的第三方登录类型&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    AuthConfig.<span class="type">AuthConfigBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> AuthConfig.builder()</span><br><span class="line">        .clientId(obj.getClientId())</span><br><span class="line">        .clientSecret(obj.getClientSecret())</span><br><span class="line">        .redirectUri(obj.getRedirectUri())</span><br><span class="line">        .scopes(obj.getScopes());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">switch</span> (source.toLowerCase()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;dingtalk&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">AuthDingTalkV2Request</span>(builder.build(), STATE_CACHE);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;baidu&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">AuthBaiduRequest</span>(builder.build(), STATE_CACHE);</span><br><span class="line">            <span class="comment">// ... </span></span><br><span class="line">            <span class="comment">// 此处省略若干</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;welink&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">AuthWelinkRequest</span>(builder.build(), STATE_CACHE);</span><br><span class="line">        <span class="keyword">default</span> -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(<span class="string">&quot;未获取到有效的Auth配置&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没错，socialProperties.getType() 返回的是 map 类型，就是用于读取 yml 配置文件中配置内容构造对应的 AuthRequest 类。</p>
<p>所以总结一下：AuthController 中 login 方法就是执行对应平台的 AuthRequest 类中的 login 方法。</p>
<p>本文中的 AuthWelinkRequest 之所以要重写基类 AuthDefaultRequest 中的 login 方法，是因为 Welink  获取用户信息的流程不太一样，需要先获取 userId 才能获取用户信息，再重复定义一遍 responseError 也是因为基类中的该方法是 private，子类无法调用。</p>
<p>回到 SocialAuthStrategy 中 login 方法后面代码部分，获取到三方平台的用户信息后会去查询 sys_social 表，检查是否有此账号绑定记录，没有则则抛出异常提示需要先进行绑定。如果有记录则查询对应的系统用户 Id，然后通过 Id 获取系统用户信息，使用 SaToken 生成 token 进行登录。</p>
<p>AuthController 中 socialCallback 方法则先对用户登录状态判断，只有登录状态才会调用 SocialUtils.loginAuth 方法，上面分析了这实际就是调用对应平台的 AuthRequest 类中的 login 方法获取三方用户信息。然后通过 loginService.socialRegister 方法去新增或修改绑定记录。</p>
<h2 id="RuoYiPlus-适配"><a href="#RuoYiPlus-适配" class="headerlink" title="RuoYiPlus 适配"></a>RuoYiPlus 适配</h2><p>由于在扫码登录时，Welink 的认证需要向第三方传递前端传过来 code 参数，并且需要先获取 userId 才能获取用户信息，所以本文和官方的扩展流程有些许不同。</p>
<h3 id="后端改造"><a href="#后端改造" class="headerlink" title="后端改造"></a>后端改造</h3><p>application-dev.yml 增加 Welink 平台配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">justauth:</span></span><br><span class="line">  <span class="comment"># 前端访问地址，不能使用 localhost</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">https://www.example.com:80</span></span><br><span class="line">  <span class="attr">type:</span></span><br><span class="line">    <span class="attr">welink:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">2025xxxxxxxxxxx1413</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">xxxxxxxxxxxxx</span></span><br><span class="line">      <span class="attr">redirect-uri:</span> <span class="string">$&#123;justauth.address&#125;/social-callback?source=welink</span> <span class="comment"># 前端路由</span></span><br></pre></td></tr></table></figure>

<p>AuthWelinkSource.java 定义接口地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AuthWelinkSource</span> <span class="keyword">implements</span> <span class="title class_">AuthSource</span> &#123;</span><br><span class="line">    WELINK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">snsAuthorize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://login.welink.huaweicloud.com/sso/oauth2/sns_authorize&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://login.welink.huaweicloud.com/sso/oauth2/authorize&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">accessToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://open.welink.huaweicloud.com/api/auth/v2/tickets&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://open.welink.huaweicloud.com/api/contact/v2/user/detail&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">AuthDefaultRequest</span>&gt; getTargetClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> AuthWelinkRequest.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">userId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;https://open.welink.huaweicloud.com/api/auth/v2/userid&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AuthWelinkRequest.java 发送请求：</p>
<p>相比较官方示例代码，注意改变了以下几点：：</p>
<ol>
<li>重写的 getUserInfo(AuthToken authToken) 方法啥也没写，因为用不到</li>
<li>增加了 getUserInfoById(AuthToken authToken, AuthCallback authCallback) 方法，增加一个参数获取 code，即 authCallback.code</li>
<li>增加了 getUserId 方法</li>
<li>重载了 authorize 方法，分别用于扫码登录和绑定账号两个不同场景</li>
<li>没有使用自带的 doGetXxxxxx 或 doPostXxxxxx 方法，而是使用封装的 OkHttp 库，封装代码将放在文章末尾。因为使用 doPostAuthorizationCode 请求 access_token 时返回内容一直提示：”clientId为空”，其实请求时是有传递 client_id 的，换了之后就成功了。我猜测是因为自带的 doPostXxxxxx 并没有把请求参数放在 body 里面而是以 <code>?client_id=xxx&amp;client_secret=xxx</code> 这种方式拼接在 url 后面导致的</li>
<li>重写了 login 方法 和 增加了 responseError 方法（这两个方法就是仿照基类 AuthDefaultRequest 中对应方法写的）。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthWelinkRequest</span> <span class="keyword">extends</span> <span class="title class_">AuthDefaultRequest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthWelinkRequest</span><span class="params">(AuthConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(config, AuthWelinkSource.WELINK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthWelinkRequest</span><span class="params">(AuthConfig config, AuthStateCache authStateCache)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(config, AuthWelinkSource.WELINK, authStateCache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthUser <span class="title function_">getUserInfo</span><span class="params">(AuthToken authToken)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthToken <span class="title function_">getAccessToken</span><span class="params">(AuthCallback authCallback)</span> &#123;</span><br><span class="line">        <span class="comment">// AuthCallback 这里用不到</span></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;client_id&quot;</span>, <span class="built_in">this</span>.config.getClientId());</span><br><span class="line">        params.put(<span class="string">&quot;client_secret&quot;</span>, <span class="built_in">this</span>.config.getClientSecret());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        headers.put(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        headers.put(<span class="string">&quot;x-wlk-gray&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> OkHttpUtil.post(UrlBuilder.fromBaseUrl(<span class="built_in">this</span>.source.accessToken()).build(), JSON.toJSONString(params), MediaType.parse(<span class="string">&quot;application/json&quot;</span>), headers);</span><br><span class="line">            object = JSONObject.parseObject(body);</span><br><span class="line">            log.info(<span class="string">&quot;welink get access token success, access token body:[&#123;&#125;]&quot;</span>, body);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;get welink access token fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AuthToken.<span class="type">AuthTokenBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> AuthToken.builder();</span><br><span class="line">        <span class="keyword">if</span>(object != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.checkResponse(object))&#123;</span><br><span class="line">            builder.accessToken(object.getString(<span class="string">&quot;access_token&quot;</span>))</span><br><span class="line">                .expireIn(object.getInteger(<span class="string">&quot;expires_in&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AuthUser <span class="title function_">getUserInfoById</span><span class="params">(AuthToken authToken, AuthCallback authCallback)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserId(authToken, authCallback.getCode());</span><br><span class="line">        AuthUser.<span class="type">AuthUserBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> AuthUser.builder();</span><br><span class="line">        <span class="keyword">if</span>(userId == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> builder.build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        headers.put(<span class="string">&quot;x-wlk-Authorization&quot;</span>, authToken.getAccessToken());</span><br><span class="line">        headers.put(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        headers.put(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> OkHttpUtil.post(UrlBuilder.fromBaseUrl(AuthWelinkSource.WELINK.userInfo()).build(), JSON.toJSONString(params), MediaType.parse(<span class="string">&quot;application/json&quot;</span>), headers);</span><br><span class="line">            object = JSONObject.parseObject(body);</span><br><span class="line">            log.info(<span class="string">&quot;welink get user info success, user info body:[&#123;&#125;]&quot;</span>, body);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;get welink user info fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(object != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.checkResponse(object))&#123;</span><br><span class="line">            <span class="type">AuthUserGender</span> <span class="variable">gender</span> <span class="operator">=</span> <span class="keyword">switch</span> (object.getString(<span class="string">&quot;sex&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;F&quot;</span> -&gt; AuthUserGender.FEMALE;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;M&quot;</span> -&gt; AuthUserGender.MALE;</span><br><span class="line">                <span class="keyword">default</span> -&gt; AuthUserGender.UNKNOWN;</span><br><span class="line">            &#125;;</span><br><span class="line">            builder.uuid(object.getString(<span class="string">&quot;userId&quot;</span>))</span><br><span class="line">                .username(object.getString(<span class="string">&quot;employeeId&quot;</span>))</span><br><span class="line">                .nickname(object.getString(<span class="string">&quot;userNameCn&quot;</span>))</span><br><span class="line">                .avatar(object.getString(<span class="string">&quot;avatar&quot;</span>))</span><br><span class="line">                .email(object.getString(<span class="string">&quot;userEmail&quot;</span>))</span><br><span class="line">                .company(object.getString(<span class="string">&quot;mainDeptCode&quot;</span>))</span><br><span class="line">                .gender(gender)</span><br><span class="line">                .token(authToken)</span><br><span class="line">                .source(source.toString())</span><br><span class="line">                .rawUserInfo(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">(AuthToken authToken, String code)</span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; headers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        headers.put(<span class="string">&quot;x-wlk-Authorization&quot;</span>, authToken.getAccessToken());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> OkHttpUtil.get(UrlBuilder.fromBaseUrl(AuthWelinkSource.WELINK.userId()).build(), headers, params);</span><br><span class="line">            object = JSONObject.parseObject(body);</span><br><span class="line">            log.info(<span class="string">&quot;welink get user id success, user id body:[&#123;&#125;]&quot;</span>, body);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;get welink user id fail&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(object != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.checkResponse(object))&#123;</span><br><span class="line">            <span class="keyword">return</span> object.getString(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">(String code, String state)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UrlBuilder.fromBaseUrl(AuthWelinkSource.WELINK.snsAuthorize())</span><br><span class="line">            .queryParam(<span class="string">&quot;response_type&quot;</span>, <span class="string">&quot;code&quot;</span>)</span><br><span class="line">            .queryParam(<span class="string">&quot;client_id&quot;</span>, <span class="built_in">this</span>.config.getClientId())</span><br><span class="line">            .queryParam(<span class="string">&quot;redirect_uri&quot;</span>, URLEncoder.encode(<span class="built_in">this</span>.config.getRedirectUri(), StandardCharsets.UTF_8))</span><br><span class="line">            .queryParam(<span class="string">&quot;state&quot;</span>, <span class="built_in">this</span>.getRealState(state))</span><br><span class="line">            .queryParam(<span class="string">&quot;scope&quot;</span>, <span class="string">&quot;snsapi_login&quot;</span>)</span><br><span class="line">            .queryParam(<span class="string">&quot;code&quot;</span>, code)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">authorize</span><span class="params">(String state)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UrlBuilder.fromBaseUrl(AuthWelinkSource.WELINK.authorize())</span><br><span class="line">            .queryParam(<span class="string">&quot;response_type&quot;</span>, <span class="string">&quot;code&quot;</span>)</span><br><span class="line">            .queryParam(<span class="string">&quot;client_id&quot;</span>, <span class="built_in">this</span>.config.getClientId())</span><br><span class="line">            .queryParam(<span class="string">&quot;redirect_uri&quot;</span>, URLEncoder.encode(<span class="built_in">this</span>.config.getRedirectUri(), StandardCharsets.UTF_8))</span><br><span class="line">            .queryParam(<span class="string">&quot;state&quot;</span>, <span class="built_in">this</span>.getRealState(state))</span><br><span class="line">            .queryParam(<span class="string">&quot;scope&quot;</span>, <span class="string">&quot;backendlogin&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthResponse&lt;AuthUser&gt; <span class="title function_">login</span><span class="params">(AuthCallback authCallback)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.config.isIgnoreCheckState()) &#123;</span><br><span class="line">                AuthChecker.checkState(authCallback.getState(), <span class="built_in">this</span>.source, <span class="built_in">this</span>.authStateCache);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">AuthToken</span> <span class="variable">authToken</span> <span class="operator">=</span> <span class="built_in">this</span>.getAccessToken(authCallback);</span><br><span class="line">            <span class="type">AuthUser</span> <span class="variable">user</span> <span class="operator">=</span> <span class="built_in">this</span>.getUserInfoById(authToken, authCallback);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> AuthResponse.&lt;AuthUser&gt;builder().code(AuthResponseStatus.SUCCESS.getCode()).data(user).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var4) &#123;</span><br><span class="line">            Log.error(<span class="string">&quot;Failed to login with oauth authorization.&quot;</span>, var4);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.responseError(var4);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkResponse</span><span class="params">(JSONObject object)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(object == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;response body is null, request fail！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!Objects.equals(object.getString(<span class="string">&quot;code&quot;</span>), <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">            log.error(<span class="string">&quot;response body message: &#123;&#125;&quot;</span>, object.getString(<span class="string">&quot;message&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    AuthResponse&lt;AuthUser&gt; <span class="title function_">responseError</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">errorCode</span> <span class="operator">=</span> AuthResponseStatus.FAILURE.getCode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> e.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AuthException authException) &#123;</span><br><span class="line">            errorCode = authException.getErrorCode();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(authException.getErrorMsg())) &#123;</span><br><span class="line">                errorMsg = authException.getErrorMsg();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AuthResponse.&lt;AuthUser&gt;builder().code(errorCode).msg(errorMsg).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AuthController 类中 authBinding 方法新增 code 参数，并对 Welink 平台扫码登录时特殊处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/binding/&#123;source&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;String&gt; <span class="title function_">authBinding</span><span class="params">(<span class="meta">@PathVariable(&quot;source&quot;)</span> String source, <span class="meta">@RequestParam(required = false)</span> String code,</span></span><br><span class="line"><span class="params">                             <span class="meta">@RequestParam</span> String tenantId, <span class="meta">@RequestParam</span> String domain)</span> &#123;</span><br><span class="line">    <span class="type">SocialLoginConfigProperties</span> <span class="variable">obj</span> <span class="operator">=</span> socialProperties.getType().get(source);</span><br><span class="line">    <span class="keyword">if</span> (ObjectUtil.isNull(obj)) &#123;</span><br><span class="line">        <span class="keyword">return</span> R.fail(source + <span class="string">&quot;平台账号暂不支持&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AuthRequest</span> <span class="variable">authRequest</span> <span class="operator">=</span> SocialUtils.getAuthRequest(source, socialProperties);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;tenantId&quot;</span>, tenantId);</span><br><span class="line">    map.put(<span class="string">&quot;domain&quot;</span>, domain);</span><br><span class="line">    map.put(<span class="string">&quot;state&quot;</span>, AuthStateUtils.createState());</span><br><span class="line">    String authorizeUrl;</span><br><span class="line">    <span class="keyword">if</span>(authRequest <span class="keyword">instanceof</span> AuthWelinkRequest welinkRequest &amp;&amp; !StringUtils.isBlank(code))&#123;</span><br><span class="line">        <span class="comment">// 仅 welink 扫码登录需要特殊处理，welink 绑定时同其它平台一样</span></span><br><span class="line">        authorizeUrl = welinkRequest.authorize(code, Base64.encode(JsonUtils.toJsonString(map), StandardCharsets.UTF_8));</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        authorizeUrl = authRequest.authorize(Base64.encode(JsonUtils.toJsonString(map), StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;authorize url: &quot;</span> + authorizeUrl);</span><br><span class="line">    <span class="keyword">return</span> R.ok(<span class="string">&quot;操作成功&quot;</span>, authorizeUrl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SocialUtils 类中 getAuthRequest 方法中增加 case：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AuthRequest <span class="title function_">getAuthRequest</span><span class="params">(String source, SocialProperties socialProperties)</span> <span class="keyword">throws</span> AuthException &#123;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">    <span class="comment">// 此处省略若干</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">switch</span> (source.toLowerCase()) &#123;</span><br><span class="line">	<span class="comment">// ... </span></span><br><span class="line">	<span class="comment">// 此处省略若干</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;welink&quot;</span> -&gt; <span class="keyword">new</span> <span class="title class_">AuthWelinkRequest</span>(builder.build(), STATE_CACHE);</span><br><span class="line">        <span class="keyword">default</span> -&gt; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthException</span>(<span class="string">&quot;未获取到有效的Auth配置&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="前端改造"><a href="#前端改造" class="headerlink" title="前端改造"></a>前端改造</h3><p>前端涉及到登录页和绑定应用页，需要改造 login.vue 和 thirdParty.vue 页面。</p>
<p>auth.ts 中 authBinding 方法增加 code 参数：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绑定账号</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">authBinding</span>(<span class="params">source: <span class="built_in">string</span>, tenantId: <span class="built_in">string</span>, code: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/auth/binding/&#x27;</span> + source,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123;</span><br><span class="line">      <span class="attr">code</span>: code,</span><br><span class="line">      <span class="attr">tenantId</span>: tenantId,</span><br><span class="line">      <span class="attr">domain</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">host</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.js 引入 js 文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://login.welink.huaweicloud.com/sso-proxy-front/public/qrcode/0.0.1/wlQrcodeLogin.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>assets&#x2F;icons&#x2F;svg 放入 welink.svg 图标</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://img.kecho.top/i/2025/09/06/k04l7r.png"
                        alt="Welink"
                 ></p>
<p>lang&#x2F;zh_CN.ts 和 en_US.ts 增加 <code>login.social.welink</code> 语言内容：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zh_CN.ts</span></span><br><span class="line"><span class="attr">login</span>: &#123;  </span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    <span class="attr">social</span>: &#123;</span><br><span class="line">		<span class="attr">welink</span>: <span class="string">&#x27;Welink 登录&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// en_US.ts</span></span><br><span class="line"><span class="attr">login</span>: &#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">    <span class="attr">social</span>: &#123;</span><br><span class="line">		<span class="attr">welink</span>: <span class="string">&#x27;Welink Login&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>login.vue 中使用 Element-Plus 中的 Dialog 组件来展示二维码，使用 <code>@opened</code> 实现打开弹窗时调用函数生成二维码。</p>
<p><strong>注意</strong>：redirectUri 的域名或 IP 需要和 Welink 后台设置的 “应用管理后台” 地址保持一致，并且不能使用 localhost，否则可能导致二维码生成失败。</p>
<p>代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;!-- Welink 扫码登录弹窗 --&gt;</span><br><span class="line">    &lt;el-dialog v-model=&quot;isWelinkLogin&quot; </span><br><span class="line">        :title=&quot;proxy.$t(&#x27;login.social.welink&#x27;)&quot; </span><br><span class="line">        @opened=&quot;getWelinkLoginERCode&quot;</span><br><span class="line">        width=&quot;500&quot; center align-center&gt;</span><br><span class="line">        &lt;div class=&quot;welink-login-dialog&quot;&gt;</span><br><span class="line">            &lt;div id=&quot;welink-login-container&quot;&gt;&lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 是否 welink 登录</span><br><span class="line">const isWelinkLogin = ref(false);</span><br><span class="line"></span><br><span class="line">// 生成二维码</span><br><span class="line">const getWelinkLoginERCode = () =&gt; &#123;</span><br><span class="line">  const clientId = &quot;2025xxxxxxxxxxx1413&quot;;</span><br><span class="line">  const state = Date.now().toString();</span><br><span class="line">  const redirectUri  = &#x27;https://www.example.com/social-callback?source=welink&#x27;;</span><br><span class="line">  window.wlQrcodeLogin(&#123;</span><br><span class="line">    id: &quot;welink-login-container&quot;, // 这里需要你在自己的页面定义一个 HTML 标签并设置 id，例如 &lt;div id=&quot;welink-login-container&quot;&gt;&lt;/div&gt;，也可以使用 span</span><br><span class="line">    client_id: clientId, </span><br><span class="line">    response_type: &quot;code&quot;, </span><br><span class="line">    scope: &quot;snsapi_login&quot;, </span><br><span class="line">    state: state, </span><br><span class="line">    redirect_uri: redirectUri,</span><br><span class="line">    style: &quot;border:none;background-color:#FFFFFF;&quot;,</span><br><span class="line">    width : &quot;400&quot;,</span><br><span class="line">    height: &quot;300&quot;,</span><br><span class="line">    lang: &#x27;cn&#x27;,</span><br><span class="line">    self_redirect: false</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">const getWelinkLoginCode = (event: MessageEvent) =&gt; &#123;</span><br><span class="line">  const origin = event.origin;</span><br><span class="line">  if(origin === &quot;https://login.welink.huaweicloud.com&quot;) &#123;</span><br><span class="line">    console.log(event)</span><br><span class="line">    const code = event.data as string;</span><br><span class="line">    console.log(code);</span><br><span class="line">    if(code) &#123;</span><br><span class="line">      // 发送请求将 code 传递给后端</span><br><span class="line">      doSocialLogin(&#x27;welink&#x27;, code)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  window.addEventListener(&quot;message&quot;, getWelinkLoginCode, false);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">onBeforeUnmount(() =&gt; &#123;</span><br><span class="line">  window.removeEventListener(&quot;message&quot;, getWelinkLoginCode, false);</span><br><span class="line">&#125;)</span><br><span class="line">    </span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.welink-login-dialog &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: center;</span><br><span class="line">  align-items: center;</span><br><span class="line">  height: 100%;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>thirtyParty.vue 中在可绑定应用中增加 Welink：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;authlist&quot; class=&quot;user-bind&quot;&gt;</span><br><span class="line">    &lt;a class=&quot;third-app&quot; href=&quot;#&quot; title=&quot;使用 Welink 账号授权登录&quot; @click=&quot;authUrl(&#x27;welink&#x27;)&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;git-other-login-icon&quot;&gt;</span><br><span class="line">            &lt;svg-icon icon-class=&quot;welink&quot; /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;span class=&quot;app-name&quot;&gt;Welink&lt;/span&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">    &lt;!-- 省略其它列表 --&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>



<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="OkHttp-封装"><a href="#OkHttp-封装" class="headerlink" title="OkHttp 封装"></a>OkHttp 封装</h3><p>Maven 引入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>OkHttpUtil 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OkHttpUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">get</span><span class="params">(String url, Map&lt;String, String&gt; headers, Map&lt;String, String&gt; urlParams)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder();</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (headers != <span class="literal">null</span>) &#123;</span><br><span class="line">            builder.headers(setHeaders(headers));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (urlParams != <span class="literal">null</span>) &#123;</span><br><span class="line">            builder.url(setUrlParams(url, urlParams));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            builder.url(url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute())&#123;</span><br><span class="line">            <span class="keyword">if</span>(response.body() != <span class="literal">null</span>)&#123;</span><br><span class="line">                result = response.body().string();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">post</span><span class="params">(String url, String json, MediaType mediaType)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> RequestBody.create(json, mediaType);</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(url)</span><br><span class="line">            .post(body)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute())&#123;</span><br><span class="line">            <span class="keyword">if</span>(response.body() != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> response.body().string();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 新增：支持自定义 header 的 post 方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">post</span><span class="params">(String url, String json, MediaType mediaType, Map&lt;String, String&gt; headers)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> RequestBody.create(json, mediaType);</span><br><span class="line">        Request.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">            .url(url)</span><br><span class="line">            .post(body);</span><br><span class="line">        <span class="keyword">if</span> (headers != <span class="literal">null</span>) &#123;</span><br><span class="line">            builder.headers(setHeaders(headers));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> okHttpClient.newCall(request).execute())&#123;</span><br><span class="line">            <span class="keyword">if</span>(response.body() != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> response.body().string();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Headers <span class="title function_">setHeaders</span><span class="params">(Map&lt;String, String&gt; headersParams)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        okhttp3.Headers.<span class="type">Builder</span> <span class="variable">headersbuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">okhttp3</span>.Headers.Builder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (headersParams != <span class="literal">null</span>) &#123;</span><br><span class="line">            Iterator&lt;String&gt; iterator = headersParams.keySet().iterator();</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                key = iterator.next();</span><br><span class="line">                headersbuilder.add(key, headersParams.get(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        headers = headersbuilder.build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">setUrlParams</span><span class="params">(String url, Map&lt;String, String&gt; mapParams)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">strParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> (mapParams != <span class="literal">null</span>) &#123;</span><br><span class="line">            Iterator&lt;String&gt; iterator = mapParams.keySet().iterator();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : mapParams.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!strParams.isEmpty()) &#123;</span><br><span class="line">                    strParams.append(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                strParams.append(entry.getKey()).append(<span class="string">&quot;=&quot;</span>).append(entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (url.endsWith(<span class="string">&quot;?&quot;</span>)) &#123;</span><br><span class="line">                url += strParams;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                url += <span class="string">&quot;?&quot;</span> + strParams;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何读取-yml-配置"><a href="#如何读取-yml-配置" class="headerlink" title="如何读取 yml 配置"></a>如何读取 yml 配置</h3><p>首先定义一个 SocialProperties 类，使用 @ConfigurationProperties 注解将 yml 下 justauth.* 的内容映射到这个类里面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;justauth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocialProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, SocialLoginConfigProperties&gt; type;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后定义一个配置类，使用 @EnableConfigurationProperties 注解来启用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SocialProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocialAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthStateCache <span class="title function_">authStateCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthRedisStateCache</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/JustAuth/">JustAuth</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Welink/">Welink</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="分享到 QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="分享到微信"
            data-tooltip-img-tip="微信扫一扫"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="分享到微博"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/posts/a7ea8c76.html"
                                   title="使用 Snail Job 定时任务同步 Welink 部门和用户信息"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">使用 Snail Job 定时任务同步 Welink 部门和用户信息</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/posts/6fd3c141.html"
                                   title="出栈顺序个数之卡特兰数"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">出栈顺序个数之卡特兰数</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">评论插件加载失败</span>
    <button class="reload keep-button">点击重新加载</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">正在加载评论插件</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="gitalk-comment-container">
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.css">
        <script 
                src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initGitalk = () => {
            let gitalkPathname = decodeURI(location.pathname)
            const gitalkPathnameLength = gitalkPathname.length
            const gitalkPathnameMaxLength = 50
            if (gitalkPathnameLength > gitalkPathnameMaxLength) {
              gitalkPathname = gitalkPathname.substring(0, gitalkPathnameMaxLength - 3) + '...'
            }

            if (window?.Gitalk) {
              new Gitalk({
                clientID: 'Ov23lijlSHIogUNeavXU',
                clientSecret: '14f1771243fbbcaa595c6f2bf116556a00f9de81',
                repo: 'HexoBlogComment',
                owner: 'kechocy',
                admin: 'kechocy',
                id: gitalkPathname,
                proxy: '',
                language: 'zh-CN'
              }).render('gitalk-container')
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initGitalk()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initGitalk()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initGitalk)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BD%91%E7%AB%99-Welink-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">第三方网站 Welink 登录流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E5%85%8D%E7%99%BB%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">前台免登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E5%85%8D%E7%99%BB%E5%BD%95"><span class="nav-number">1.2.</span> <span class="nav-text">管理后台免登录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JustAuth-%E6%89%A9%E5%B1%95%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">JustAuth 扩展流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%A7%A3-RuoYiPlus-%E4%B8%AD%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">理解 RuoYiPlus 中三方登录流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RuoYiPlus-%E9%80%82%E9%85%8D"><span class="nav-number">4.</span> <span class="nav-text">RuoYiPlus 适配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0"><span class="nav-number">4.1.</span> <span class="nav-text">后端改造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%94%B9%E9%80%A0"><span class="nav-number">4.2.</span> <span class="nav-text">前端改造</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OkHttp-%E5%B0%81%E8%A3%85"><span class="nav-number">5.1.</span> <span class="nav-text">OkHttp 封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96-yml-%E9%85%8D%E7%BD%AE"><span class="nav-number">5.2.</span> <span class="nav-text">如何读取 yml 配置</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2022</span>&nbsp;-&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">Kecho</a>
        
    </div>

    <!-- <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div> -->

    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">28.8k</span>
                </span>
            

            

            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E7%BD%91%E7%AB%99-Welink-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">第三方网站 Welink 登录流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0%E5%85%8D%E7%99%BB%E5%BD%95"><span class="nav-number">1.1.</span> <span class="nav-text">前台免登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0%E5%85%8D%E7%99%BB%E5%BD%95"><span class="nav-number">1.2.</span> <span class="nav-text">管理后台免登录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JustAuth-%E6%89%A9%E5%B1%95%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">JustAuth 扩展流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%90%86%E8%A7%A3-RuoYiPlus-%E4%B8%AD%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">理解 RuoYiPlus 中三方登录流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RuoYiPlus-%E9%80%82%E9%85%8D"><span class="nav-number">4.</span> <span class="nav-text">RuoYiPlus 适配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E6%94%B9%E9%80%A0"><span class="nav-number">4.1.</span> <span class="nav-text">后端改造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%94%B9%E9%80%A0"><span class="nav-number">4.2.</span> <span class="nav-text">前端改造</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OkHttp-%E5%B0%81%E8%A3%85"><span class="nav-number">5.1.</span> <span class="nav-text">OkHttp 封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96-yml-%E9%85%8D%E7%BD%AE"><span class="nav-number">5.2.</span> <span class="nav-text">如何读取 yml 配置</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
            
<script src="/js/post/share.js"></script>

        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



    
        
    

</body>
</html>
